name: Deploy to EC2 (demo / Docker over SSH)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1Ô∏è‚É£ Build: SSH Ïó∞Í≤∞ ÌôïÏù∏ + /srv/demo Í∏∞Î≥∏Í∂åÌïú ÏÑ∏ÌåÖ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Prepare /srv/demo directory (sudo)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -euxo pipefail; \
             sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}; \
             sudo chown -R $USER:$USER /srv/demo; \
             sudo find /srv/demo -type d -exec chmod 755 {} +; \
             echo "‚úÖ /srv/demo ready and owned by $(id -un)"'

  # 2Ô∏è‚É£ Sync: ÏΩîÎìú ÎèôÍ∏∞Ìôî
  sync:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Rsync project to EC2
        run: |
          rsync -az --delete \
            -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

      - name: Sanity check permissions
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -eux; \
             ls -ld /srv /srv/demo /srv/demo/projects /srv/demo/projects/${{ secrets.APP_NAME }}; \
             sudo chown -R $USER:$USER /srv/demo/projects/${{ secrets.APP_NAME }} || true'

  # 3Ô∏è‚É£ Deploy: Docker ÎπåÎìú + Ïã§Ìñâ + Ìó¨Ïä§Ï≤¥ÌÅ¨
  deploy:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Remote build and run (no profile/norc)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "bash --noprofile --norc -euxo pipefail -c '
              APP=\"${{ secrets.APP_NAME }}\"
              HOST_PORT=\"${{ secrets.HOST_PORT }}\"
              CONTAINER_PORT=\"${{ secrets.CONTAINER_PORT }}\"
              [ -z \"$CONTAINER_PORT\" ] && CONTAINER_PORT=8080
              WORKDIR=/srv/demo/projects/\$APP

              echo \"üîß Working dir: \$WORKDIR\"
              cd \"\$WORKDIR\"

              # 0Ô∏è‚É£ Ìè¨Ìä∏ Ï†êÏú† Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ (Ïòà: 9001)
              sudo docker ps -q --filter \"publish=\${HOST_PORT}\" | xargs -r sudo docker rm -f || true

              # 1Ô∏è‚É£ Ïù¥Ï†Ñ ÎèôÏùº Ïù¥Î¶Ñ Ïª®ÌÖåÏù¥ÎÑà Ï†úÍ±∞
              sudo docker rm -f app_\${APP} 2>/dev/null || true

              # 2Ô∏è‚É£ ÎπåÎìú
              sudo docker build -t \${APP}:latest .

              # 3Ô∏è‚É£ ÎÑ§Ìä∏ÏõåÌÅ¨ Ï§ÄÎπÑ
              sudo docker network create demo_net 2>/dev/null || true

              # 4Ô∏è‚É£ Ïã§Ìñâ
              sudo docker run -d --name app_\${APP} \
                --network demo_net \
                -p \${HOST_PORT}:\${CONTAINER_PORT} \
                --cpus=\"0.5\" --memory=\"512m\" --pids-limit=256 \
                --restart unless-stopped \
                -e PORT=\${CONTAINER_PORT} \
                \${APP}:latest

              echo \"ü©∫ Checking health...\"
              for i in {1..30}; do
                if curl -fsS \"http://127.0.0.1:\${HOST_PORT}/\" >/dev/null; then
                  echo \"‚úÖ Health OK\"
                  exit 0
                fi
                sleep 1
              done

              echo \"‚ùå Health check failed\"
              sudo docker logs --tail=200 app_\${APP} || true
              exit 1
            '"
