name: Deploy to EC2 (demo-a frontend)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1ï¸âƒ£ Build: ì›ê²© ì„œë²„ì— ë°°í¬ í´ë”ë¥¼ ì¤€ë¹„í•˜ê³  ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Prepare remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            set -euxo pipefail
            
            # ì›ê²© ì„œë²„ì˜ í˜„ì¬ ìœ ì € ì´ë¦„($USER)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            REMOTE_USER=$(id -un)
            
            # í”„ë¡œì íŠ¸ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (-p ì˜µì…˜ìœ¼ë¡œ ìƒìœ„ í´ë”ë„ ìë™ ìƒì„±)
            sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}
            
            # ìƒì„±í•œ í´ë”ì˜ ì†Œìœ ê¶Œì„ í˜„ì¬ ìœ ì €ì—ê²Œ ë¶€ì—¬í•©ë‹ˆë‹¤.
            sudo chown -R $REMOTE_USER:$REMOTE_USER /srv/demo
            
            echo "âœ… Directory /srv/demo/projects/${{ secrets.APP_NAME }} is ready."
          '

  # 2ï¸âƒ£ Sync: GitHubì˜ ìµœì‹  ì½”ë“œë¥¼ ì›ê²© ì„œë²„ë¡œ ë™ê¸°í™”(ë³µì‚¬)í•©ë‹ˆë‹¤.
  sync:
    runs-on: ubuntu-latest
    needs: build # build ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë©ë‹ˆë‹¤.
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Rsync project files to EC2
        run: |
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

  # 3ï¸âƒ£ Deploy: ë™ê¸°í™”ëœ ìµœì‹  ì½”ë“œë¡œ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  deploy:
    runs-on: ubuntu-latest
    needs: sync # sync ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë©ë‹ˆë‹¤.
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Remote build, run, and health check
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOSSH'
            set -euxo pipefail
            
            # GitHub Secretsë¡œë¶€í„° ë³€ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            APP="${{ secrets.APP_NAME }}"
            HOST_PORT="${{ secrets.HOST_PORT }}"
            # â—â—â— [ìˆ˜ì •ëœ ë¶€ë¶„] â—â—â—
            # secrets.CONTAINER_PORT ê°’ì´ ì—†ìœ¼ë©´ ì…¸ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ 3000ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            CONTAINER_PORT="${{ secrets.CONTAINER_PORT }:-3000}"
            WORKDIR="/srv/demo/projects/$APP"
            CONTAINER_NAME="app_${APP}"

            echo "---- [front] Deploying $APP to $HOST_PORT:$CONTAINER_PORT ----"
            cd "$WORKDIR"

            # 0ï¸âƒ£ ê¸°ì¡´ì— ë™ì¼í•œ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë˜ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ëª¨ë‘ ì¢…ë£Œ ë° ì œê±°
            if sudo docker ps -q --filter "publish=${HOST_PORT}" | grep -q .; then
              echo "Stopping container(s) using port ${HOST_PORT}..."
              sudo docker ps -q --filter "publish=${HOST_PORT}" | xargs sudo docker rm -f
            fi

            # 1ï¸âƒ£ ì´ì „ ë²„ì „ì˜ ì•± ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ì¢…ë£Œ ë° ì œê±°
            if sudo docker ps -a -q --filter "name=${CONTAINER_NAME}" | grep -q .; then
              echo "Removing old container ${CONTAINER_NAME}..."
              sudo docker rm -f "$CONTAINER_NAME"
            fi
            
            # 2ï¸âƒ£ ìµœì‹  ì½”ë“œë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ
            echo "Building Docker image ${APP}:latest..."
            sudo docker build -t "${APP}:latest" .

            # 3ï¸âƒ£ Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ í†µê³¼)
            sudo docker network create demo_net || true

            # 4ï¸âƒ£ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "Running new container ${CONTAINER_NAME}..."
            sudo docker run -d --name "$CONTAINER_NAME" \
              --network demo_net \
              -p "${HOST_PORT}:${CONTAINER_PORT}" \
              --cpus="0.5" --memory="512m" --pids-limit=256 \
              --restart unless-stopped \
              -e PORT="${CONTAINER_PORT}" \
              "${APP}:latest"

            # 5ï¸âƒ£ í—¬ìŠ¤ ì²´í¬
            echo "ğŸ©º Health checking..."
            for i in {1..30}; do
              # /healthz ë˜ëŠ” / ê²½ë¡œë¡œ ì ‘ì†ì„ ì‹œë„í•˜ì—¬ ì„±ê³µí•˜ë©´ ë°°í¬ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
              if curl -fsS "http://127.0.0.1:${HOST_PORT}/healthz" >/dev/null 2>&1 || \
                 curl -fsS "http://127.0.0.1:${HOST_PORT}/" >/dev/null 2>&1; then
                echo "âœ… Health check successful!"
                exit 0
              fi
              echo "Waiting for container to be healthy... ($i/30)"
              sleep 1
            done
            
            # 30ì´ˆ ì•ˆì— í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ ì‹œ
            echo "âŒ Health check failed after 30 seconds."
            echo "Displaying container logs:"
            sudo docker logs --tail 100 "$CONTAINER_NAME" || true
            exit 1
          EOSSH
