name: Deploy to EC2 (demo / Docker over SSH)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1) Build: Ïó∞Í≤∞/ÌÇ§ Ï§ÄÎπÑÎßå (Îπ†Î¶Ñ)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Verify SSH & prepare base dir ownership (once and for all)
        run: |
          # /srv/demo Î•º ÎÑ§ ÏÇ¨Ïö©Ïûê ÏÜåÏú†Î°ú Í≥†Ï†ïÌï¥ ÎëêÎ©¥ rsyncÏóê sudoÍ∞Ä ÌïÑÏöî ÏóÜÏñ¥ÏßëÎãàÎã§.
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -euxo pipefail; \
             sudo mkdir -p /srv/demo/projects && \
             sudo chown -R $USER:$USER /srv/demo && \
             mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }} && \
             echo "‚úÖ ownership fixed: $(id -un) owns /srv/demo"'

  # 2) Sync: sudo ÏóÜÏù¥ rsync (root ÏÜåÏú† Î¨∏Ï†úÏùò Í∑ºÎ≥∏ ÏõêÏù∏ Ï†úÍ±∞)
  sync:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Rsync project to EC2 (no sudo needed)
        run: |
          rsync -az --delete \
            -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

      - name: Sanity check perms (defensive)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -eux; \
             ls -ld /srv/demo /srv/demo/projects /srv/demo/projects/${{ secrets.APP_NAME }}; \
             # ÌòπÏãúÎùºÎèÑ Î£®Ìä∏Í∞Ä ÏÑûÏòÄÏúºÎ©¥ ÌïúÎ≤à Îçî Ï†ïÎ¶¨
             find /srv/demo/projects/${{ secrets.APP_NAME }} -maxdepth 1 -mindepth 0 -exec bash -lc "sudo chown -R $USER:$USER {}" \;'

  # 3) Deploy: ÎèÑÏª§ ÎπåÎìú/Ïã§Ìñâ (dockerÎäî sudoÎ°ú Ïã§ÌñâÌï¥ Í∂åÌïú Ïù¥Ïäà ÏõêÏ≤ú Ï∞®Îã®)
  deploy:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Remote build and run (sudo docker)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
              set -euxo pipefail

              APP='${{ secrets.APP_NAME }}'
              HOST_PORT='${{ secrets.HOST_PORT }}'
              CONTAINER_PORT='${{ secrets.CONTAINER_PORT }}'
              [ -z "$CONTAINER_PORT" ] && CONTAINER_PORT=8080
              WORKDIR=/srv/demo/projects/$APP

              echo "üîß Working dir: $WORKDIR"
              cd "$WORKDIR"

              # (0) docker ÏÇ¨Ïö© Í∂åÌïú Î∞©Ïñ¥Ï†Å Ï°∞Ïπò (Î°úÍ∑∏Ïù∏ ÏÑ∏ÏÖò Í∞±Ïã† ÌïÑÏöîÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑ† sudo docker ÏÇ¨Ïö© Ïú†ÏßÄ)
              if ! groups | grep -q '\bdocker\b'; then
                sudo usermod -aG docker "$USER" || true
              fi

              # (1) Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
              sudo docker rm -f app_${APP} 2>/dev/null || true

              # (2) ÏÉà Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
              sudo docker build -t ${APP}:latest .

              # (3) ÎÑ§Ìä∏ÏõåÌÅ¨ Ï§ÄÎπÑ
              sudo docker network create demo_net 2>/dev/null || true

              # (4) ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
              sudo docker run -d --name app_${APP} \
                --network demo_net \
                -p ${HOST_PORT}:${CONTAINER_PORT} \
                --cpus="0.5" --memory="512m" --pids-limit=256 \
                --restart unless-stopped \
                -e PORT=${CONTAINER_PORT} \
                ${APP}:latest

              # (5) Ìó¨Ïä§ Ï≤¥ÌÅ¨ (Î£®ÌîÑ/Ïä¨Î¶ΩÏúºÎ°ú ÏïàÏ†ïÌôî ÎåÄÍ∏∞)
              echo "ü©∫ Checking health..."
              for i in {1..30}; do
                if curl -fsS "http://127.0.0.1:${HOST_PORT}/" >/dev/null; then
                  echo "‚úÖ Health OK"
                  exit 0
                fi
                sleep 1
              done

              echo "‚ùå Health check failed, showing logs"
              sudo docker logs --tail=200 app_${APP} || true
              exit 1
            EOF
