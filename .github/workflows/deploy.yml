name: Deploy to EC2 (demo-a frontend)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1ï¸âƒ£ Build: ì›ê²© ì„œë²„ì— ë°°í¬ í´ë”ë¥¼ ì¤€ë¹„í•˜ê³  ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Prepare remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            set -euxo pipefail
            
            REMOTE_USER=$(id -un)
            sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}
            sudo chown -R $REMOTE_USER:$REMOTE_USER /srv/demo
            
            echo "âœ… Directory /srv/demo/projects/${{ secrets.APP_NAME }} is ready."
          '

  # 2ï¸âƒ£ Sync: GitHubì˜ ìµœì‹  ì½”ë“œë¥¼ ì›ê²© ì„œë²„ë¡œ ë™ê¸°í™”(ë³µì‚¬)í•©ë‹ˆë‹¤.
  sync:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Rsync project files to EC2
        run: |
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

  # 3ï¸âƒ£ Deploy: ë™ê¸°í™”ëœ ìµœì‹  ì½”ë“œë¡œ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  deploy:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Remote build, run, and health check
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            # â—â—â— [ìˆ˜ì •ëœ ë¶€ë¶„] â—â—â—
            # 1. GitHub Secretsë¥¼ ì›ê²© ì„œë²„ì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¨¼ì € export í•©ë‹ˆë‹¤.
            #    ì—¬ê¸°ì„œëŠ” GitHub Actionsê°€ ${{...}}ë¥¼ ì •ìƒì ìœ¼ë¡œ í•´ì„í•©ë‹ˆë‹¤.
            export APP='${{ secrets.APP_NAME }}'
            export HOST_PORT='${{ secrets.HOST_PORT }}'
            export CONTAINER_PORT='${{ secrets.CONTAINER_PORT }}'

            # 2. exportëœ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            #    <<'EOSSH'ëŠ” ì´ì œ ì•ˆì „í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤.
            bash -s <<'EOSSH'
              set -euxo pipefail
              
              # exportëœ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
              # CONTAINER_PORT ë³€ìˆ˜ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì…¸ì´ ê¸°ë³¸ê°’ 3000ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
              CONTAINER_PORT=\${CONTAINER_PORT:-3000}
              WORKDIR="/srv/demo/projects/\$APP"
              CONTAINER_NAME="app_\$APP"

              echo "---- [front] Deploying \$APP to \$HOST_PORT:\$CONTAINER_PORT ----"
              cd "\$WORKDIR"

              if sudo docker ps -q --filter "publish=\${HOST_PORT}" | grep -q .; then
                echo "Stopping container(s) using port \${HOST_PORT}..."
                sudo docker ps -q --filter "publish=\${HOST_PORT}" | xargs sudo docker rm -f
              fi

              if sudo docker ps -a -q --filter "name=\${CONTAINER_NAME}" | grep -q .; then
                echo "Removing old container \${CONTAINER_NAME}..."
                sudo docker rm -f "\$CONTAINER_NAME"
              fi
              
              echo "Building Docker image \${APP}:latest..."
              sudo docker build -t "\${APP}:latest" .

              sudo docker network create demo_net || true

              echo "Running new container \${CONTAINER_NAME}..."
              sudo docker run -d --name "\$CONTAINER_NAME" \
                --network demo_net \
                -p "\${HOST_PORT}:\${CONTAINER_PORT}" \
                --cpus="0.5" --memory="512m" --pids-limit=256 \
                --restart unless-stopped \
                -e PORT="\${CONTAINER_PORT}" \
                "\${APP}:latest"

              echo "ğŸ©º Health checking..."
              for i in {1..30}; do
                if curl -fsS "http://127.0.0.1:\${HOST_PORT}/healthz" >/dev/null 2>&1 || \
                   curl -fsS "http://127.0.0.1:\${HOST_PORT}/" >/dev/null 2>&1; then
                  echo "âœ… Health check successful!"
                  exit 0
                fi
                echo "Waiting for container to be healthy... (\$i/30)"
                sleep 1
              done
              
              echo "âŒ Health check failed after 30 seconds."
              echo "Displaying container logs:"
              sudo docker logs --tail 100 "\$CONTAINER_NAME" || true
              exit 1
            EOSSH
          "
