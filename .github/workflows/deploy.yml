name: Deploy to EC2 (demo / Docker over SSH)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1) Build: Ïó∞Í≤∞/ÌÇ§ Ï§ÄÎπÑ + /srv/demo ÎîîÎ†âÌÜ†Î¶¨/ÏÜåÏú†Í∂å ÌôïÏ†ï (Î™®Îëê sudo)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Prepare /srv/demo (create+own via sudo, idempotent)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -euxo pipefail; \
             # 1) Î£®Ìä∏ Í∂åÌïúÏúºÎ°ú Í≤ΩÎ°ú Ï†ÑÎ∂Ä ÏÉùÏÑ±
             sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}; \
             # 2) demo Ìä∏Î¶¨ Ï†ÑÏ≤¥Î•º ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏÜåÏú†Í∂å Ïù¥Ï†Ñ
             sudo chown -R $USER:$USER /srv/demo; \
             # 3) Ï†ëÍ∑ºÍ∂åÌïú Î≥¥Ï†ï
             sudo find /srv/demo -type d -exec chmod 755 {} +; \
             echo "‚úÖ /srv/demo ready and owned by $(id -un)"'

  # 2) Sync: sudo ÏóÜÏù¥ rsync (root ÏÜåÏú† Î¨∏Ï†ú Í∑ºÎ≥∏ Ï†úÍ±∞)
  sync:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Rsync project to EC2 (no sudo)
        run: |
          rsync -az --delete \
            -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

      - name: Sanity check perms (defensive)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'set -eux; \
             ls -ld /srv /srv/demo /srv/demo/projects /srv/demo/projects/${{ secrets.APP_NAME }}; \
             # ÌòπÏãúÎùºÎèÑ Î£®Ìä∏Í∞Ä ÏÑûÏòÄÏúºÎ©¥ Ìïú Î≤à Îçî Ï†ïÎ¶¨
             sudo chown -R $USER:$USER /srv/demo/projects/${{ secrets.APP_NAME }} || true'

  # 3) Deploy: ÎèÑÏª§ ÎπåÎìú/Ïã§Ìñâ (ÏïàÏ†ÑÌïòÍ≤å sudo docker ÏÇ¨Ïö©)
  deploy:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Remote build and run (sudo docker)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
              set -euxo pipefail

              APP='${{ secrets.APP_NAME }}'
              HOST_PORT='${{ secrets.HOST_PORT }}'
              CONTAINER_PORT='${{ secrets.CONTAINER_PORT }}'
              [ -z "$CONTAINER_PORT" ] && CONTAINER_PORT=8080
              WORKDIR=/srv/demo/projects/$APP

              echo "üîß Working dir: $WORKDIR"
              cd "$WORKDIR"

              # (0) docker Í∂åÌïúÏùÄ ÎÇòÏ§ëÏóê Ï†ïÎ¶¨ÌïòÎçîÎùºÎèÑ, ÏßÄÍ∏àÏùÄ sudo dockerÎ°ú ÏïàÏ†Ñ Ïã§Ìñâ
              if ! command -v docker >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io
              fi

              # (1) Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
              sudo docker rm -f app_${APP} 2>/dev/null || true

              # (2) ÏÉà Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
              sudo docker build -t ${APP}:latest .

              # (3) ÎÑ§Ìä∏ÏõåÌÅ¨ Ï§ÄÎπÑ
              sudo docker network create demo_net 2>/dev/null || true

              # (4) ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
              sudo docker run -d --name app_${APP} \
                --network demo_net \
                -p ${HOST_PORT}:${CONTAINER_PORT} \
                --cpus="0.5" --memory="512m" --pids-limit=256 \
                --restart unless-stopped \
                -e PORT=${CONTAINER_PORT} \
                ${APP}:latest

              # (5) Ìó¨Ïä§ Ï≤¥ÌÅ¨
              echo "ü©∫ Checking health..."
              for i in {1..30}; do
                if curl -fsS "http://127.0.0.1:${HOST_PORT}/" >/dev/null; then
                  echo "‚úÖ Health OK"
                  exit 0
                fi
                sleep 1
              done

              echo "‚ùå Health check failed, showing logs"
              sudo docker logs --tail=200 app_${APP} || true
              exit 1
            EOF
