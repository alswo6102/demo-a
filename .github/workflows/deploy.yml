name: Deploy to EC2 (demo / Docker over SSH)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1Ô∏è‚É£ Build Îã®Í≥Ñ (Í≥µÌÜµ Ï§ÄÎπÑ)
  build:
    runs-on: ubuntu-latest
    outputs:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      APP_NAME: ${{ secrets.APP_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Verify connection
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "echo '‚úÖ EC2 SSH connection OK'"

  # 2Ô∏è‚É£ Sync Îã®Í≥Ñ (build ÏÑ±Í≥µ ÌõÑ)
  sync:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Prepare target dir on EC2 (sudo)
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}/"

      - name: Rsync project to EC2 (sudo on remote)
        run: |
          rsync -az --delete \
            --rsync-path="sudo rsync" \
            -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

      - name: Fix ownership after rsync
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo chown -R \$(id -un):\$(id -gn) /srv/demo/projects/${{ secrets.APP_NAME }} && \
             sudo find /srv/demo/projects/${{ secrets.APP_NAME }} -type d -exec chmod 755 {} +"

  # 3Ô∏è‚É£ Deploy Îã®Í≥Ñ (sync ÏÑ±Í≥µ ÌõÑ)
  deploy:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Remote build and run
        run: |
          ssh -tt -i key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
              set -e

              APP='${{ secrets.APP_NAME }}'
              HOST_PORT='${{ secrets.HOST_PORT }}'
              CONTAINER_PORT='${{ secrets.CONTAINER_PORT }}'
              [ -z "$CONTAINER_PORT" ] && CONTAINER_PORT=8080
              WORKDIR=/srv/demo/projects/$APP

              echo "üîß Working dir: $WORKDIR"
              cd "$WORKDIR"

              # (1) Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
              docker rm -f app_${APP} 2>/dev/null || true

              # (2) ÏÉà Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
              docker build -t ${APP}:latest .

              # (3) ÎÑ§Ìä∏ÏõåÌÅ¨ Ï§ÄÎπÑ
              docker network create demo_net 2>/dev/null || true

              # (4) ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
              docker run -d --name app_${APP} \
                --network demo_net \
                -p ${HOST_PORT}:${CONTAINER_PORT} \
                --cpus="0.5" --memory="512m" --pids-limit=256 \
                --restart unless-stopped \
                -e PORT=${CONTAINER_PORT} \
                ${APP}:latest

              # (5) Ìó¨Ïä§Ï≤¥ÌÅ¨
              echo "ü©∫ Checking health..."
              for i in {1..20}; do
                if curl -fsS "http://127.0.0.1:${HOST_PORT}/" >/dev/null; then
                  echo "‚úÖ Health OK"
                  exit 0
                fi
                sleep 1
              done

              echo "‚ùå Health check failed"
              docker logs --tail=200 app_${APP} || true
              exit 1
            EOF
