name: Deploy to EC2 (demo / Docker over SSH)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ SSH í‚¤ ì„¸íŒ…
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # 3ï¸âƒ£ í”„ë¡œì íŠ¸ í´ë”ë¥¼ EC2ë¡œ ë™ê¸°í™”
      - name: Rsync project to EC2
        run: |
          rsync -az --delete -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

      # 4ï¸âƒ£ EC2 ë‚´ë¶€ì—ì„œ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì¬ê¸°ë™
      - name: Remote build and run
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            APP=${{ secrets.APP_NAME }}
            HOST_PORT=${{ secrets.HOST_PORT }}
            CONTAINER_PORT=${{ secrets.CONTAINER_PORT || 8080 }}
            WORKDIR=/srv/demo/projects/$APP

            echo "ğŸ”§ Working dir: $WORKDIR"
            cd "$WORKDIR"

            # (1) ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker rm -f app_${APP} 2>/dev/null || true

            # (2) ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
            docker build -t ${APP}:latest .

            # (3) ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d --name app_${APP} \
              --network demo_net \
              -p ${HOST_PORT}:${CONTAINER_PORT} \
              --cpus="0.5" --memory="512m" --pids-limit=256 \
              --restart unless-stopped \
              -e PORT=${CONTAINER_PORT} \
              ${APP}:latest

            # (4) ê°„ë‹¨ í—¬ìŠ¤ ì²´í¬
            echo "ğŸ©º Checking health..."
            for i in {1..20}; do
              if curl -fsS http://127.0.0.1:${HOST_PORT}/health >/dev/null; then
                echo "âœ… Health OK"
                exit 0
              fi
              sleep 1
            done

            echo "âŒ Health check failed"
            docker logs --tail=200 app_${APP} || true
            exit 1
          EOF
