name: Deploy to EC2 (demo / Docker over SSH)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2) SSH í‚¤ ì„¸íŒ…
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # 3) ëŒ€ìƒ ë””ë ‰í„°ë¦¬ ì‚¬ì „ ìƒì„± (ì›ê²©ì—ì„œ sudo)
      - name: Prepare target dir on EC2 (sudo)
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}/"

      # 4) í”„ë¡œì íŠ¸ ë™ê¸°í™” (ì›ê²©ì—ì„œ rsyncë¥¼ sudoë¡œ ì‹¤í–‰)
      - name: Rsync project to EC2 (sudo on remote)
        run: |
          rsync -az --delete \
            --rsync-path="sudo rsync" \
            -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

      # 5) ì›ê²©ì—ì„œ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì¬ê¸°ë™
      - name: Remote build and run
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            set -e

            APP='${{ secrets.APP_NAME }}'
            HOST_PORT='${{ secrets.HOST_PORT }}'
            CONTAINER_PORT='${{ secrets.CONTAINER_PORT }}'
            [ -z "\$CONTAINER_PORT" ] && CONTAINER_PORT=8080
            WORKDIR=/srv/demo/projects/\$APP

            echo "ğŸ”§ Working dir: \$WORKDIR"
            cd "\$WORKDIR"

            # (1) ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker rm -f app_\$APP 2>/dev/null || true

            # (2) ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
            docker build -t \$APP:latest .

            # (3) ë„¤íŠ¸ì›Œí¬ ì¤€ë¹„
            docker network create demo_net 2>/dev/null || true

            # (4) ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d --name app_\$APP \
              --network demo_net \
              -p \$HOST_PORT:\$CONTAINER_PORT \
              --cpus="0.5" --memory="512m" --pids-limit=256 \
              --restart unless-stopped \
              -e PORT=\$CONTAINER_PORT \
              \$APP:latest

            # (5) ê°„ë‹¨ í—¬ìŠ¤ ì²´í¬ (/ ë¡œ ì²´í¬)
            echo "ğŸ©º Checking health..."
            for i in {1..20}; do
              if curl -fsS "http://127.0.0.1:\$HOST_PORT/" >/dev/null; then
                echo "âœ… Health OK"
                exit 0
              fi
              sleep 1
            done

            echo "âŒ Health check failed"
            docker logs --tail=200 app_\$APP || true
            exit 1
          EOF
