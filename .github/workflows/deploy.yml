name: Deploy to EC2 (demo-a frontend)

on:
  push:
    branches: [ "main" ]

jobs:
  # 1ï¸âƒ£ Build: ì›ê²© ì„œë²„ì— ë°°í¬ í´ë”ë¥¼ ì¤€ë¹„í•˜ê³  ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤. (ë³€ê²½ ì—†ìŒ)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Prepare remote directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            set -euxo pipefail
            REMOTE_USER=$(id -un)
            sudo mkdir -p /srv/demo/projects/${{ secrets.APP_NAME }}
            sudo chown -R $REMOTE_USER:$REMOTE_USER /srv/demo
            echo "âœ… Directory /srv/demo/projects/${{ secrets.APP_NAME }} is ready."
          '

  # 2ï¸âƒ£ Sync: GitHubì˜ ìµœì‹  ì½”ë“œë¥¼ ì›ê²© ì„œë²„ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤. (ë³€ê²½ ì—†ìŒ)
  sync:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Rsync project files to EC2
        run: |
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=no" ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/srv/demo/projects/${{ secrets.APP_NAME }}/

  # 3ï¸âƒ£ Deploy: ë™ê¸°í™”ëœ ì½”ë“œë¡œ Docker ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. (â—ì™„ì „íˆ ì¬ì‘ì„±ëœ ë¶€ë¶„â—)
  deploy:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Remote Build, Run, and Health Check
        # â— [í•µì‹¬] env í‚¤ì›Œë“œë¡œ ë³€ìˆ˜ë¥¼ ë¨¼ì € ëª…í™•í•˜ê²Œ ì •ì˜í•©ë‹ˆë‹¤.
        env:
          REMOTE_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_USER: ${{ secrets.EC2_USER }}
          APP: ${{ secrets.APP_NAME }}
          HOST_PORT: ${{ secrets.HOST_PORT }}
          CONTAINER_PORT: ${{ secrets.CONTAINER_PORT }} # ê¸°ë³¸ê°’ì€ ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
        
        run: |
          # â— [í•µì‹¬] ì •ì˜ëœ env ë³€ìˆ˜ë“¤ì„ ì›ê²© ì„œë²„ë¡œ ë„˜ê²¨ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
          # ì´ êµ¬ì¡°ëŠ” ë³€ìˆ˜ ì¶©ëŒì´ ì ˆëŒ€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "
            # ë³€ìˆ˜ë¥¼ ì›ê²© ì…¸ í™˜ê²½ì— ì„¤ì •
            export APP='$APP'
            export HOST_PORT='$HOST_PORT'
            export CONTAINER_PORT='$CONTAINER_PORT'

            # ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            bash -s" << 'EOF'
              set -euxo pipefail
              
              # ì…¸ ë¬¸ë²•ìœ¼ë¡œ CONTAINER_PORTê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ 3000ì„ ì‚¬ìš©
              EFFECTIVE_CONTAINER_PORT=${CONTAINER_PORT:-3000}
              
              WORKDIR="/srv/demo/projects/$APP"
              CONTAINER_NAME="app_$APP"

              echo "---- [front] Deploying $APP to $HOST_PORT:$EFFECTIVE_CONTAINER_PORT ----"
              cd "$WORKDIR"

              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
              if sudo docker ps -q --filter "publish=$HOST_PORT" | grep -q .; then
                echo "Stopping container(s) using port $HOST_PORT..."
                sudo docker ps -q --filter "publish=$HOST_PORT" | xargs sudo docker rm -f
              fi
              if sudo docker ps -a -q --filter "name=$CONTAINER_NAME" | grep -q .; then
                echo "Removing old container $CONTAINER_NAME..."
                sudo docker rm -f "$CONTAINER_NAME"
              fi
              
              # ë¹Œë“œ ë° ì‹¤í–‰
              echo "Building Docker image $APP:latest..."
              sudo docker build -t "$APP:latest" .
              sudo docker network create demo_net || true
              
              echo "Running new container $CONTAINER_NAME..."
              sudo docker run -d --name "$CONTAINER_NAME" \
                --network demo_net \
                -p "$HOST_PORT:$EFFECTIVE_CONTAINER_PORT" \
                --cpus="0.5" --memory="512m" --pids-limit=256 \
                --restart unless-stopped \
                -e PORT="$EFFECTIVE_CONTAINER_PORT" \
                "$APP:latest"

              # í—¬ìŠ¤ ì²´í¬
              echo "ğŸ©º Health checking..."
              for i in {1..30}; do
                if curl -fsS "http://127.0.0.1:$HOST_PORT/healthz" >/dev/null 2>&1 || \
                   curl -fsS "http://127.0.0.1:$HOST_PORT/" >/dev/null 2>&1; then
                  echo "âœ… Health check successful!"
                  exit 0
                fi
                echo "Waiting for container to be healthy... ($i/30)"
                sleep 1
              done
              
              echo "âŒ Health check failed after 30 seconds."
              sudo docker logs --tail 100 "$CONTAINER_NAME" || true
              exit 1
          EOF
